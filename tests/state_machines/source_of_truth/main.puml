@startuml
state STATE_RUNNING {
    state STATE_IDLE
    state STATE_TRIGGERING {
        state STATE_SAMPLE_DATA
        state STATE_WAIT_FOR_TRIGGER

        [*] --> STATE_SAMPLE_DATA
    }

    [*] --> STATE_IDLE

    STATE_IDLE --> STATE_TRIGGERING: CLOUD_CONNECTED
    STATE_TRIGGERING --> STATE_IDLE: CLOUD_DISCONNECTED
    STATE_SAMPLE_DATA --> STATE_WAIT_FOR_TRIGGER: LOCATION_SEARCH_DONE
    STATE_WAIT_FOR_TRIGGER --> STATE_SAMPLE_DATA: TIMER || BUTTON
}

state STATE_FOTA {
    state STATE_FOTA_DOWNLOADING
    state STATE_FOTA_WAITING_FOR_NETWORK_DISCONNECT
    state STATE_FOTA_WAITING_FOR_NETWORK_DISCONNECT_TO_APPLY_IMAGE
    state STATE_FOTA_APPLYING_IMAGE
    state STATE_FOTA_REBOOTING

    [*] --> STATE_FOTA_DOWNLOADING

    STATE_FOTA_DOWNLOADING --> STATE_FOTA_WAITING_FOR_NETWORK_DISCONNECT: FOTA_SUCCESS_REBOOT_NEEDED
    STATE_FOTA_DOWNLOADING --> STATE_FOTA_WAITING_FOR_NETWORK_DISCONNECT_TO_APPLY_IMAGE: FOTA_IMAGE_APPLY_NEEDED
    STATE_FOTA_WAITING_FOR_NETWORK_DISCONNECT --> STATE_FOTA_REBOOTING: NETWORK_DISCONNECTED
    STATE_FOTA_WAITING_FOR_NETWORK_DISCONNECT_TO_APPLY_IMAGE --> STATE_FOTA_APPLYING_IMAGE: NETWORK_DISCONNECTED
    STATE_FOTA_APPLYING_IMAGE --> STATE_FOTA_REBOOTING: FOTA_SUCCESS_REBOOT_NEEDED
}

[*] --> STATE_RUNNING

STATE_RUNNING --> STATE_FOTA: FOTA_DOWNLOADING_UPDATE
STATE_FOTA --> STATE_TRIGGERING: FOTA_DOWNLOAD_CANCELED || FOTA_DOWNLOAD_TIMED_OUT || FOTA_DOWNLOAD_FAILED [connected]
STATE_FOTA --> STATE_IDLE: FOTA_DOWNLOAD_CANCELED || FOTA_DOWNLOAD_TIMED_OUT || FOTA_DOWNLOAD_FAILED [!connected]
@enduml
