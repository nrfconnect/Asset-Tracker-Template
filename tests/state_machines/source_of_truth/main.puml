@startuml
state STATE_RUNNING {
    state STATE_IDLE
    state STATE_TRIGGERING {
        state STATE_SAMPLE_DATA
        state STATE_WAIT_FOR_TRIGGER

        [*] --> STATE_SAMPLE_DATA

        STATE_SAMPLE_DATA --> STATE_WAIT_FOR_TRIGGER: LOCATION_SEARCH_DONE
        STATE_WAIT_FOR_TRIGGER --> STATE_SAMPLE_DATA: TIMER_CHAN
        STATE_WAIT_FOR_TRIGGER --> STATE_SAMPLE_DATA: BUTTON_CHAN
    }
    [*] --> STATE_IDLE

    STATE_RUNNING --> STATE_TRIGGERING: connected
    STATE_RUNNING --> STATE_IDLE: not connected
    STATE_RUNNING --> STATE_FOTA: FOTA_DOWNLOADING_UPDATE

    STATE_IDLE --> STATE_TRIGGERING: CLOUD_CONNECTED
    STATE_TRIGGERING --> STATE_IDLE: CLOUD_DISCONNECTED
}

state STATE_FOTA {
    state STATE_FOTA_DOWNLOADING
    state STATE_FOTA_WAITING_FOR_NETWORK_DISCONNECT
    state STATE_FOTA_WAITING_FOR_NETWORK_DISCONNECT_TO_APPLY_IMAGE
    state STATE_FOTA_APPLYING_IMAGE
    state STATE_FOTA_REBOOTING

    [*] --> STATE_FOTA_DOWNLOADING

    STATE_FOTA_DOWNLOADING --> STATE_FOTA_WAITING_FOR_NETWORK_DISCONNECT: FOTA_SUCCESS_REBOOT_NEEDED
    STATE_FOTA_DOWNLOADING --> STATE_FOTA_WAITING_FOR_NETWORK_DISCONNECT_TO_APPLY_IMAGE: FOTA_IMAGE_APPLY_NEEDED

    STATE_FOTA_WAITING_FOR_NETWORK_DISCONNECT --> STATE_FOTA_REBOOTING: NETWORK_DISCONNECTED
    STATE_FOTA_WAITING_FOR_NETWORK_DISCONNECT_TO_APPLY_IMAGE --> STATE_FOTA_APPLYING_IMAGE: NETWORK_DISCONNECTED
    STATE_FOTA_APPLYING_IMAGE --> STATE_FOTA_REBOOTING: FOTA_SUCCESS_REBOOT_NEEDED

    STATE_FOTA --> STATE_RUNNING: FOTA_DOWNLOAD_CANCELED || FOTA_DOWNLOAD_TIMED_OUT || FOTA_DOWNLOAD_FAILED
}

[*] --> STATE_RUNNING
@enduml
